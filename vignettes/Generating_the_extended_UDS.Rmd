---
title: "Generating the Extended Unified Democracy Scores"
author: "Xavier Marquez"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Generating the Extended Unified Democracy Scores}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

The ```extended_uds``` dataset can be generated with the following code:

```{r generation, echo = TRUE}
library(dplyr)
library(QuickUDS)

indexes <- c("arat_pmm", "blm", "bmr_democracy",
             "bnr", "bollen_pmm", "doorenspleet",
             "eiu","freedomhouse", "freedomhouse_electoral",
             "gwf", "hadenius_pmm", "kailitz_tri",
             "lied", "mainwaring", "magaloni_regime_tri",
             "munck_pmm", "pacl", "PEPS1v",
             "pitf", "polity2", "polyarchy_contestation",
             "prc_notrans", "svolik", "ulfelder", 
             "utip_dichotomous_strict", "v2x_polyarchy", 
             "vanhanen_democratization", "wahman_teorell_hadenius")

# Generate Extended UDS
data <- QuickUDS::democracy[ , c("country_name", 
                                 "GWn", "cown",
                                 "year", "region",
                                "continent", "microstate",
                                "lat", "lon",
                                "in_system", indexes)]

data <- reshape2::melt(data, measure.vars = indexes, na.rm = TRUE)
data <- data %>% 
  group_by(country_name,year) %>% 
  mutate(measures_per_cy = n()) %>% 
  ungroup()
data <- reshape2::dcast(data, ... ~ variable)
data <- data %>% arrange(country_name,year)

data2 <- prepare_democracy(indexes)


extended_model <- democracy_model(data2,
                                  indexes, 
                                  verbose=FALSE, 
                                  technical = list(NCYCLES = 2500))

extended_scores <- democracy_scores(extended_model)
extended_uds <- bind_cols(data,extended_scores)

```

The model takes about 3-5 minutes to converge on my machine, and accounts for more than 90 per cent of the variance in the various democracy indexes used:

```{r time, echo = TRUE}
extended_model@time

# Number of iterations, log likelihood, etc.
extended_model

# Correlations of latent factor with source variables, variance accounted for, etc.
summary(extended_model)

```

## Normalizing the scores

The UD scores are more useful when normalized to a 0-1 index, where the midpoint is set to the  average latent variable cutpoint for the dichotomous democracy measures used. This score can then be interepreted as a kind of probability measure: country-years with scores close to 1 are almost certainly democratic, while country-years with scores close to 0 are almost certainly not, while 0.5 represents the cut-off between democracy and non-democracy. We can easily normalize the scores with the following code. 

First, we calculate the cutpoints for the various measures:

```{r cutpoints, echo = TRUE}
cutpoints_extended <- cutpoints(extended_model)

cutpoints_extended
```

Then we extract the cutpoints for the dichotomous undexes of democracy, and average them:

```{r dichotnomousCutpoints, echo = TRUE}

dichotomous_cutpoints <- cutpoints_extended %>% 
  group_by(variable) %>%
  filter(n() == 1) 

dichotomous_cutpoints

avg_dichotomous <- mean(dichotomous_cutpoints$estimate)

avg_dichotomous
```

Finally, we adjust the calculated latent score by substracting the average dichotomous cutpoint and using the cumulative normal distribution function to normalize it to the -1 range (with mean 0.5, which is now the average dichotomous cutpoint):

```{r adjustZscore, echo = TRUE}

extended_uds <- extended_uds %>% mutate(adj.z1 = z1 - avg_dichotomous, 
                                        adj.pct025 = pct025 - avg_dichotomous, 
                                        adj.pct975 = pct975 - avg_dichotomous,
                                        index = pnorm(adj.z1),
                                        index.pct025 = pnorm(adj.pct025),
                                        index.pct975 = pnorm(adj.pct975))
```

For a more complete introduction to the available functions in the package, and to other ways of calculating see the [package vignettes](/articles). 

## Scores by country

The extended UD scores are available for ```r nrow(extended_uds)``` country-years (```r length(unique(extended_uds$country_name))``` unique countries and non-sovereign territories):

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.height=30}
library(ggplot2)

count_sequence_breaks <- function(seq, seq_step = 1) {
  first_diff <- c(seq_step, diff(seq)) - seq_step
  periods <- cumsum(abs(first_diff))
  periods
}

extended_uds <- extended_uds %>% 
  group_by(country_name) %>% 
  mutate(group = count_sequence_breaks(year), 
         group2 = count_sequence_breaks(in_system,seq_step = 0), 
         group3 = paste(group,group2))

data <- extended_uds

countries <- unique(data$country_name)

periods_of_independence <- data %>% 
  group_by(country_name,group3,in_system) %>% 
  summarise(start = min(year), end = max(year)) %>% 
  filter(in_system)

ggplot() + 
  geom_path(data = data %>% 
              filter(country_name %in% countries[1:112]), 
            aes(x = year,y = index, group = group)) + 
  geom_ribbon(data = data %>% 
                filter(country_name %in% countries[1:112]), 
              aes(x = year, ymin = index.pct025, 
                  ymax = index.pct975, group = group), 
              alpha=0.2) + 
  theme_bw() + 
  labs(x = "Year", 
       y = "Extended unified democracy score,
       transformed to 0-1 probability scale, per year",
       color = "")  + 
  theme(legend.position = "bottom") + 
  guides(color = guide_legend(ncol=1),fill = guide_legend(nrow=1)) + 
  facet_wrap(~country_name,ncol=4) +
  geom_hline(yintercept = 0.5, color="red") +
  geom_rect(data = periods_of_independence %>% 
              filter(country_name %in% countries[1:112]), 
            aes(xmin = start, xmax = end, ymin = 0, ymax = 1), 
            alpha = 0.2, fill = "blue")

```

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.height=30}

ggplot() + 
  geom_path(data = data %>% 
              filter(country_name %in% countries[113:224]), 
            aes(x = year,y = index, group = group)) + 
  geom_ribbon(data = data %>% 
                filter(country_name %in% countries[113:224]), 
              aes(x = year, ymin = index.pct025, 
                  ymax = index.pct975, group= group), 
              alpha=0.2) + 
  theme_bw() + 
  labs(x = "Year", 
       y = "Extended unified democracy score,
       transformed to 0-1 probability scale, per year",
       color = "")  + 
  theme(legend.position = "bottom") + 
  guides(color = guide_legend(ncol=1),fill = guide_legend(nrow=1)) + 
  facet_wrap(~country_name,ncol=4) +
  geom_hline(yintercept = 0.5, color="red") +
  geom_rect(data = periods_of_independence %>% 
              filter(country_name %in% countries[113:224]), 
            aes(xmin = start, xmax = end, ymin = 0, ymax = 1), 
            alpha = 0.2, fill = "blue")

```

(Grey shaded areas represent 95% confidence intervals; blue shaded areas are periods where the country is either deemed to be a member of the system of states in the [Gleditsch and Ward list of state system membership since 1816](http://privatewww.essex.ac.uk/~ksg/statelist.html), i.e., independent, or is a [microstate in Gleditsch's tentative list](http://privatewww.essex.ac.uk/~ksg/statelist.html)).

